---
title: 'HW 1: Анализ деятельности авиалиний и аэропортов'
author: "Петрова Екатерина, enpetrova_3"
output: html_document
---

## Задача

на основе данных (и выданных вопросов) постараться выяснить:

* какие проблемы есть в авиаперевозках
* какие улучшения можно предложить на основе выводов по данным

#### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE, echo = F}
library(dplyr)
library(ggplot2)
library(R3PO)
library(readr)
library(stringr)
library(lubridate)
library(ggplot2)

airline = get_hw1_airline_df()
airport = get_hw1_airport_df()
seat = get_hw1_seat_df()
lounge = get_hw1_lounge_df()
```

Все нужные данные для вопросов в нужных форматах

```{r echo = F}
# преобразование данных, предобработка
```


### Вопросы

#### Вопрос 1

**Вопрос:** -Люди из каких стран выше всего оценили свои перелеты?

**Данные:** для ответа на вопрос нужна таблица airline, так как авиалиния отвечает за самолет, все удобства, расписание, и его общий рейтинг показывает отношение ко всему перелету

```{r echo=FALSE, message=FALSE, warning=FALSE}
# код для ответа на вопрос 1:

task1 = airline %>% select(overall_rating, author_country)

# находим среднюю оценку для каждой страны и округляем
task1 = task1 %>% group_by(author_country) %>% summarise(mean_rate=mean(overall_rating)) 
task1 = na.omit(task1)
task1 = task1 %>% arrange(desc(mean_rate))
task1$mean_rate=round(task1$mean_rate, 1)

# нужные преобразования, построение графика, если нужен

ggplot(data = task1) + 
        geom_bar(stat = "identity", aes(x=reorder(author_country, mean_rate), y=mean_rate), fill="#008080") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        xlab("Страны") +
        ylab("Средяя оценка") +
        ggtitle("Средние оценки по странам по возрастанию")
        
```

**Ответ:** Из данного графика видно, что люди из Венгрии оценили свои перелеты выше всех, когда как люди из Люксембурга оставили отзывы с наименьшим показателем. В определенный период люди из 49 стран в среднем хорошо отозвались о своем перелете. Иногда не хватало данных, чтобы сформулировать точнее мнение о качестве совершенных перелетов. 

**Вывод:** Страны, выше всех оценившие перелёты, достаточно разнообразны по местоположению и экономическому развитию, из-за чего достаточно сложно найти в них общие черты, помогающие сделать достоверный вывод. Поэтому вдальнейшем было бы интересно вычислить среднюю оценку авиаперелетов по всему миру в определенный отрезок времени, а также брать информацию о причине поездки и взять во внимание класс перелета, чтобы посмотреть на процентное соотношение людей из этих стран с наивысшими оценками. Также можно изучить, как много людей из каждой страны летают на самолётах и имеют больше опыта для сравнения и оценки сервисов авиалиний.

#### Вопрос 2

**Вопрос:** -Отличается ли использование слов \"not good\", \"bad\", \"awful\" в отзывах на авиалинии у путешественников из разных классов (cabin_flown)?

**Данные:** нужна таблица airline, т.к. производится анализ отзывов на авиалинии

```{r echo=FALSE, message=FALSE, warning=FALSE}
# код для ответа на вопрос 2:
# нужные преобразования, построение графика, если нужен

task2 = airline %>% select(content, cabin_flown, overall_rating) 
task2$content=str_to_lower(task2$content)

#Находим количество использующих негативные слова и неиспользующих, удаляя данные, которых нет (пустые классы) 

task2 = task2 %>% mutate(negative=str_detect(task2$content, "not good|bad|awful")) %>% group_by(cabin_flown, negative)%>% na.omit() %>% summarise(n=n(),mr=mean(overall_rating)) 

#разделяем дф на два других дф относительно использования данных слов
# 
task21= task2 %>% filter(negative==TRUE) %>% select(-negative)
task22= task2 %>% filter(negative==FALSE) %>% select(-negative)
names(task21)[names(task21) == 'n'] <- 'neg' 
names(task22)[names(task22) == 'n'] <- 'pos'

#соедиянем их обратно относительно классов

task2=full_join(task21, task22, "cabin_flown")
task2[is.na(task2)] <- 0

#создаём колонку с отношением использования негативных слов на все отзывы, т.к. нужно сравнивать процентое соотношение для разных классов из-за разного количество отзывов в них

task2= task2 %>% mutate(sum=neg+pos, share_neg=neg/sum) 
task2$share_neg=round(task2$share_neg, 2)


ggplot(data=task2, aes(x=cabin_flown, y=share_neg, fill=mr.x)) + 
        geom_bar(stat = "identity", position=position_dodge()) +
        xlab("Класс") +
        ylab("Часть отзывов с негативными словами") +
        ggtitle("Использование негативных слов в отзывах в зависимости от класса") +
        scale_fill_continuous(name = "Средняя оценка", type = "viridis") 


```

**Ответ:** Люди из Эконом и Бизнесс классов, использующие слова not good, bad, awful, в процентном соотношении примерно одинаковы и составляют 14% и 12% соответственно, а в Премиум Экономе уже 20%. И, как можно заметить, самую высокую оценку из них ставят пассажиры из Бизнесс класса, чуть меньше Эконом, хотя и использование негативных слов у Бизнес класса больше, и наименьшая средняя оценка была дана людьми из Премиум Эконома, что ожидаемо.

**Вывод:** Предположительно, Премиуим Эконом класс имеет больше всех отрицательных слов, из-за того, что это люди, которые имеют недостаточно денег для Бизнес класса, но всё равно доплачивают дополнительные услуги и имеют ожидания выше. Так что возможно можно было бы улучшить качество Премиум Эконом класса в сравнении с Экономом. Так же использование слов not good, bad, awful не говорит об оценке в целом, т.к. люди могут сделать акцент на вещи, которая им не понравилось, но в целом иметь хорошее представление о полёте. Так что лучше судить о полёте через непосредственную оценку, которую они ставят за неё и среди уже низких искать негативные слова, чтобы понять, что именно им не понравилось. Так же можно взять во внимание тип пассажира и посмотреть их соотношение в каждом классе.

**Вопрос:** -Какие лаунж-зоны оценены по качеству wi-fi выше, чем аэропорты, в которых они расположены?

**Данные:** для ответа на вопрос нужны таблицы lounge и airport

```{r echo=FALSE, message=FALSE, warning=FALSE}
# код для ответа на вопрос 3:
# нужные преобразования, построение графика, если нужен

task31=lounge %>% select(lounge_name, airport, wifi_connectivity_rating)
task32=airport %>% select(airport_name, wifi_connectivity_rating)

#меняем формат названий  аэропортов чтобы по ним объединить два датафрейма

task32$airport_name=task32$airport_name %>% str_replace_all("-", " ") %>% str_to_title()

#меняем формат названий оценки wi-fi так как они являются разными
#группируем их по названиям аэропортов так как в одном аэропорте могут быть несколько лаунж зон

task32=task32 %>% rename(airport=airport_name, wifi_airport=wifi_connectivity_rating) %>% na.omit() %>% group_by(airport) %>% summarise(airport_mean_rate=mean(wifi_airport))
 
task31$lounge_name=task31$lounge_name %>% str_to_title() %>% str_remove_all("Lounge Review|Lounge Customer Review|A/B")%>% str_replace_all("First & Business Class", "F&BC") %>% str_replace_all("Business Class", "BC") %>% str_replace_all("First Class", "FC") %>% str_replace_all("\\(Alitalia\\)" , "\"Alitalia\"") %>% str_replace_all("\"Alitalia\"BC", "\"Alitalia\" BC")       

task31=task31 %>% rename(wifi_lounge=wifi_connectivity_rating) %>% na.omit() %>% group_by(lounge_name, airport) %>% summarise(lounge_mean_rate=mean(wifi_lounge))

task3=inner_join(task31, task32, by="airport") 

task3$airport=task3$airport %>% str_remove_all("Airport")

task3=task3 %>% filter(lounge_mean_rate>airport_mean_rate) %>% mutate(difference=lounge_mean_rate-airport_mean_rate) %>% arrange(-difference) %>% group_by(airport)

ggplot(data = task3) + 
        geom_bar(stat = "identity", aes(x=reorder(lounge_name, difference), y=difference, fill=airport)) +
        coord_flip()+
        xlab("Лаунж зоны") +
        ylab("Разница средней оценки качества wi-fi") +
        ggtitle("Разница между средними оценками\n качества wi-fi лаунж зон и аэропортов")+
        scale_fill_discrete(name = "Аэропорт")

ggplot(data = task3) + 
        geom_bar(stat = "identity", aes(x=reorder(lounge_name, lounge_mean_rate), y=lounge_mean_rate, fill=airport)) +
        coord_flip()+
        xlab("Лаунж зоны") +
        ylab("Средняя оценка качества wi-fi") +
        ggtitle("Cредняя оценка качества wi-fi лаунж зон")+
        scale_fill_discrete(name = "Аэропорт")
```

**Ответ:** Как представлено на графике есть 38 лаунж-зон, которые оценены выше по качеству вайфая, чем аэропорты, в которых они находятся. В сравнении с аэропортами, в которых расположены лаунж зоны, наилучшими по качеству wi-fi являются Turkish Airlines Business Class, British Airways Business Class и Emirates Business Class. 

**Вывод:**  Первый график не обязательно говорит о качетве wi-fi, т.к. может быть такое, что и в аэропорту, и в лаунж зоне они одинаково хороши, но т.к. вопрос стоял именно в сравнении, первый график выбран в таком формате. По полученным данным можно определит лаунж зоны, у которых wi-fi такой же, как и в остальном аэропорту, что может являться одним из факторов того, что люди не будут удовлетворены пребыванием в лаунжах, так как способны сранить с wi-fi в аэропорту. Также, выбрав любую лаунж зону, по тому, есть ли на графике лаунж зона другой авиалинии в том же аэропорту, но выше, чем выбранная, можно сказать, что качество в ней можно сделать лучше. В лаунж зонах очень ценится качество вайфая и люди с желанием оставляют свои отзывы, что нельзя сказать про аэропорты. Во время анализа аэропортов по средней оценке (второй график), местами не хватало данных, поэтому очень много целых средних оценок. Из этого следует, что клиенту нужно принять ряд мер по улучшению сервиса подключения в аэропортах и лаунж зонах.

### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами

**Элемент 1:** 
 - вид: график
 - ответ на вопрос: 3
 - обоснование: для вопроса "какие лаунж зоны оценены по качеству wi-fi выше, чем аэропорты, в которых они расположены" подходит перевернутая столбчатая диаграмма, т.к. она хорошо отображает насколько качество wi-fi у лаунж зон лучше, визуализирует какие лаунжи из одного аэропорта оценены выше относительно друг друга и насколько, а также по цветам диаграммы можно отследить насколько часто появляются определённые аэропорты.
 
**Элемент 2:** 
 - вид: числа
 - ответ на вопрос: 3
 - обоснование: так как лаунж зон достаточно много, их количество отображается отдельно для лучшего понимания.
 
**Элемент 3:** 
 - вид: числа
 - ответ на вопрос: 1
 - обоснование: так как можно было вставить в дэшборд только два графика/таблицы, и страны никак нельзя разделить по группам, на этот вопрос решено было выбрать самую высокую оценку и её страну.
 
**Элемент 4:** 
 - вид: график
 - ответ на вопрос: 2
 - обоснование: даётся сравнение по соотношению количества людей, использовавших негативные слова, разных классов и их выделена средняя оценка, а на данный вопрос невозможно ответить одним числом или фразой.
 
 
### Общие выводы

Предоставленные данные хороши только для поверхностного анализа деятельности авиалиний и аэропортов. Также от формулировки вопроса зависело очень много факторов анализа, так что хотелось бы иметь конечную цель, для который его хотят провести. Тем не менее, цель я считаю выполненной, и на качество авиаперевозок можно сделать краткий обзор .